# 用户系统

## 用户

用户（User）是SGT平台上唯一识别一个逻辑上的用户个体，对应了opensocial中的一个person实体

* `userid`
* `userName` 用户名
* `password` 密码
* `registryType` 注册类型，有多种不同的类型
* `nickName` 昵称
* `phoneNumber` 手机号
* `imei`
* `iccid`
* `mac`
* `email` 电子邮件

1. 用户分为多种`registryType`
2. 除了`ANDROID_AUTO`类型外，用户名和密码是必须的字段
3. 建议注册时完善电子邮件这个字段

### `MANUAL`用户(0)

基础类型，除`ANDROID_AUTO`外，都是该种类型上根据约定扩展出来

### `PHONENUMBER`用户(1)

* 用户名是手机号
* 需要设置`phonenumber`字段为手机号
* 密码默认为000000

### `ANDROID_AUTO`用户，之前为AUTO(2) 

* 用户名和密码可以为空
* `iccid`，`imei`和`mac`是必须的字段

### `WECHAT`用户(3)

微信授权用户
* 用户名是openid
* 密码默认为000000

### `WECHAT_MP`用户(4)

微信公众平台用户
* 用户名是openid
* 密码默认为000000

### `CMCC_GB`用户(5)

移动游戏基地用户
* 用户名是userid
* 密码默认为000000

## 业务接口

### `login(String name, String password)`

用户名和密码登录

### `login3rd(String id, int type)`

第三方平台登录

### `register(String imei, String iccid, String mac)`

注册ANDROID_AUTO类型的用户

### `register(megallsgpsdkentityUser user)`

完整的注册方法

### `resetPasswordByEmail(String userName)`

重置密码发送邮件

### `updatePasswordByUserName(String userName, String password)`

通过用户名更改密码

### `updateUser(megallsgpsdkentityUser user)`

更新用户信息

### `validationTokenInEmail(String userName, String token)`

检测重置密码邮件中的token有效性

## 数据校验

### 用户名和密码的校验

* 用户名由英文字母和数字组成，长度为1-32位
* 密码由英文字母和数字组成，长度为6-32位

### 设备参数的校验

* iccid少于20位则为非法
* imei少于14位则为非法
* serialno为空则为非法

### 其他信息的校验

* 昵称可以使用任意字符，长度为1-16位，如果在敏感词列表中，则为非法
* 邮箱地址必须为一个合法的email地址，长度不超过32位
* 手机号只能由数字组成，不超过16位

## 用户注册流程

### 标准类型

1. [可选]弹出一个带输入框的界面，用户输入用户名和密码
1. [可选]用户点击注册以后，本地仅保存用户名，对密码进行md5
1. 客户端进行用户名密码校验
1. 发送用户名和密码
1. 服务器端进行用户名密码校验
1. 检查是否存在同样的用户名的用户，如果不存在则插入这样一条记录，注册类型为标准，并且对密码再进行一次md5，不然则抛出“用户名已存在”的异常
1. 返回注册成功的实体

### 自动类型

1. [可选]弹出一个带快速体验游戏的按钮的界面
1. 用户点击以后，客户端采集终端的iccid，imei和mac地址，如果是一台不带3g功能的平板设备，则iccid和imei为空，在iccid处填入设备的序列号（serialno）
1. 客户端进行设备参数校验，如果所有的参数（除mac）都是非法的，则进入标准类型的注册流程
1. 发送iccid，imei和mac地址
1. 服务器端进行设备参数的校验，如果所有的参数（除mac）都是非法的，则抛出“非法参数导致自动注册失败”异常
1. 如果imei合法，则优先使用imei查询是否存在相同的记录，如果存在，则直接返回这条记录（自动登录），如果没有则插入这条记录，注册类型为自动
1. 如果iccid/serialno合法，则继续使用iccid/serialno查询是否存在相同的记录，如果存在，则直接返回这条记录（自动登录），如果没有则插入这条记录，注册类型为自动
1. 如果都不符合，则抛出“无法自动注册，请使用用户名和密码注册新用户”异常
1. 返回注册/登录成功的实体

## 用户登录流程

### 标准类型

1. [可选]弹出一个带输入框的界面，如果在注册流程中有保存的用户名，则在输入框中应该直接填入对应的用户名，用户输入用户名和密码
1. [可选]用户点击注册以后，本地仅保存用户名，对密码进行md5
1. 客户端进行用户名密码校验
1. 发送用户名和密码
1. 服务器端进行用户名密码校验
1. 检查是否存在同样的用户名和（md5以后的）密码的用户，如果存在则直接返回这条记录，如果不存在则抛出“不存在的用户名或者密码错误”异常
1. 返回登录成功的实体

### 自动类型

同用户注册流程

## 用户信息修改流程

注册成功后，如果是自动类型的用户，iccid，imei和mac3个字段是不能修改的，如果是标准类型的用户，则可以修改密码

### 用户注册类型修改

*仅支持注册类型从自动向标准类型变更*

1. 自动类型的用户登录成功
1. [可选]弹出一个带输入框的界面，用户输入用户名和密码
1. [可选]用户点击提交以后，本地仅保存用户名，对密码进行md5
1. 客户端进行用户名密码校验
1. 发送用户名和密码
1. 服务器端进行用户名密码校验
1. 根据`userid`查询出对应的用户实体，如果用户不存在，则抛出“不存在的用户”异常，设置用户名和密码的字段，并且把注册类型修改为标准类型
1. 返回修改成功的实体

### 其他用户信息修改

1. 用户登录成功
1. [可选]弹出一个带输入框的界面，用户输入其他信息
1. [可选]用户点击更新以后，仅对密码字段进行md5
1. 客户端进行用户信息校验
1. 发送用户信息
1. 服务器端进行用户信息校验
1. 根据`userid`查询出对应的用户实体，如果用户不存在，则抛出“不存在的用户”异常，设置对应的用户信息字段
1. 返回修改成功的实体